# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

variables:
  serviceConnection: 'InfonuagiqueAzure'
  resourceGroupName: 'rg-tp2-autorapide-postch'
  location: 'canadacentral'
  templateFile: '**/bicep/main.bicep'
  webAppName: 'AutoRapide'

stages:
- stage: 'RessourcesAzure'
  pool:
    vmImage: ubuntu-latest
  displayName: 'Approvisionnement des ressources Azure'
  jobs:
    - job: 'CheckRepo'
      displayName: 'Listing des répertoires'
      steps:
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            echo $(ls -Rla)
    - job: 'AzureCLI'
      displayName: 'Exécution du script bicep'
      steps:
        - task: AzureCLI@2
          env:
            DBADMINLOGIN: $(dbAdminLogin)
            DBADMINPASSWORD: $(dbAdminPassword)
          inputs:
            azureSubscription: $(serviceConnection)
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az --version
              az group create --name $(resourceGroupName) --location $(location)
              az deployment group create --resource-group $(resourceGroupName) --template-file $(templateFile) --parameters appName=$(webAppName) dbAdminLogin=$DBADMINLOGIN dbAdminPassword=$DBADMINPASSWORD
          displayName: 'Environnement de Développement'